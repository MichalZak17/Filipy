{% extends "base.html" %}
{% load static %}

{% block title %}Spotify Playlists{% endblock %}

{% block content %}
<body class="bg-gray-900 text-white font-sans">

    <section class="py-12">
        <div class="container mx-auto px-4 text-center">
            <button class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full transition duration-300 transform hover:scale-105" id="connectSpotifyBtn">
                Connect to Spotify
            </button>
            <p class="text-gray-400 mt-4">or</p>
            <h2 class="text-3xl font-bold my-4">Create a Playlist from a Vibe</h2>
            <div class="flex justify-center gap-4 my-4">
                <button class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full transition duration-300 mood-btn" data-prompt="Bright upbeat songs to boost my mood" data-modal-target="playlistPromptModal">
                    Happy Vibes
                </button>
                <button class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full transition duration-300 mood-btn" data-prompt="Calm lo-fi tracks for a quiet evening" data-modal-target="playlistPromptModal">
                    Chill & Relax
                </button>
                <button class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full transition duration-300 mood-btn" data-prompt="High-energy beats for an intense workout" data-modal-target="playlistPromptModal">
                    Energetic Beats
                </button>
            </div>
        </div>
    </section>

    <section class="py-12">
        <div class="container mx-auto px-4">
            <div class="bg-white/10 backdrop-blur-lg rounded-lg p-8 shadow-lg">
                <h2 class="text-3xl font-bold mb-6">Your Playlists</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-gray-700">
                                <th class="p-4">#</th>
                                <th class="p-4">Playlist</th>
                                <th class="p-4">Description</th>
                                <th class="p-4">Link</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for playlist in playlists %}
                            <tr class="border-b border-gray-800 hover:bg-gray-800 transition duration-200">
                                <td class="p-4">{{ forloop.counter }}</td>
                                <td class="p-4">{{ playlist.name }}</td>
                                <td class="p-4">{{ playlist.description }}</td>
                                <td class="p-4">
                                    {% if playlist.spotify_id %}
                                    <a href="https://open.spotify.com/playlist/{{ playlist.spotify_id }}" target="_blank" class="text-green-400 hover:text-green-300">
                                        Open on Spotify
                                    </a>
                                    {% else %}
                                    <span class="text-gray-500">Not available yet</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center p-8 text-gray-500">No playlists found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal -->
    <div id="playlistPromptModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg p-8 max-w-lg w-full shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h5 class="text-2xl font-bold">What do you want in your playlist?</h5>
                <button type="button" class="text-gray-400 hover:text-white" data-modal-hide="playlistPromptModal">&times;</button>
            </div>
            <div>
                <textarea id="playlistPromptInput" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3 mb-4 focus:outline-none focus:border-green-500" rows="3" placeholder="e.g. mellow acoustic for a rainy afternoon"></textarea>
                <div class="flex justify-between gap-2">
                    <button type="button" class="flex-grow bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 example-btn" data-prompt="Upbeat pop hits for a morning workout">Workout</button>
                    <button type="button" class="flex-grow bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 example-btn" data-prompt="Chill lo-fi beats to relax after work">Relax</button>
                    <button type="button" class="flex-grow bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 example-btn" data-prompt="Deep-house tracks for an evening party">Party</button>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-full transition duration-300" data-modal-hide="playlistPromptModal">Close</button>
                <button type="button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full transition duration-300" id="submitPlaylistPrompt">Submit</button>
            </div>
        </div>
    </div>
</body>
{% endblock %}

{% block extra_scripts %}
<script type="module">
  document.getElementById("connectSpotifyBtn").addEventListener("click", async ()=>{
    if(!await API.ensureSpotify()) return;
    const r = await fetch("/api/auth/spotify/login/", {
      headers: {Authorization:`Bearer ${API.getJWT()}`}
    });
    window.location = (await r.json()).url;
  });

  (async function bootstrapJWT(){
    if (localStorage.getItem("filipy_jwt")) return;
    const r = await fetch("/api/token/session/");
    if (r.ok) {
      const {access} = await r.json();
      localStorage.setItem("filipy_jwt", access);
    }
  })();

  const API = {
    getJWT:  () => localStorage.getItem("filipy_jwt") || "",
    setJWT:  t  => localStorage.setItem("filipy_jwt", t),

    async ensureSpotify () {
      const ping = await fetch("/api/playlists/", {
        headers: {Authorization:`Bearer ${API.getJWT()}`}
      });
      if (ping.status === 200) return true;
      if (ping.status === 403) {
        const r = await fetch("/api/auth/spotify/login/", {
          headers: {Authorization:`Bearer ${API.getJWT()}`}
        });
        window.location = (await r.json()).url;
        return false;
      }
      alert("Please log in first");
      return false;
    },

    async createPlaylist({name, description, prompt}) {
      await API.ensureSpotify();
      const r = await fetch("/api/playlists/", {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          Authorization:`Bearer ${API.getJWT()}`
        },
        body:JSON.stringify({name,description,mood_prompt:prompt})
      });
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    },

    async waitForSpotify(id, ms=60_000, step=3_000){
      const t0 = Date.now();
      while(Date.now()-t0 < ms){
        const r = await fetch(`/api/playlists/${id}/`,{
          headers:{Authorization:`Bearer ${API.getJWT()}`}
        });
        const p = await r.json();
        if(p.spotify_id) return p.spotify_id;
        await new Promise(res=>setTimeout(res,step));
      }
      throw new Error("Timed-out waiting for Spotify");
    }
  };

  const modal = document.getElementById('playlistPromptModal');
  document.querySelectorAll('[data-modal-target]').forEach(button => {
    button.addEventListener('click', () => {
      const target = document.getElementById(button.dataset.modalTarget);
      target.classList.remove('hidden');
    });
  });

  document.querySelectorAll('[data-modal-hide]').forEach(button => {
    button.addEventListener('click', () => {
      const target = document.getElementById(button.dataset.modalHide);
      target.classList.add('hidden');
    });
  });

  document.querySelectorAll(".mood-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      document.getElementById("playlistPromptInput").value = btn.dataset.prompt || "";
      modal.classList.remove('hidden');
    });
  });

  document.querySelectorAll(".example-btn").forEach(btn=>{
    btn.addEventListener("click", ()=> {
      document.getElementById("playlistPromptInput").value = btn.dataset.prompt;
    });
  });

  document.getElementById("submitPlaylistPrompt")
          .addEventListener("click", async ()=>{
    const prompt = document.getElementById("playlistPromptInput").value.trim();
    if(!prompt) return alert("Please enter a prompt.");

    try{
      const pl = await API.createPlaylist({
        name: prompt.slice(0,40) || "Filipy Playlist",
        description: prompt,
        prompt
      });
      const sid = await API.waitForSpotify(pl.id);
      window.open(`https://open.spotify.com/playlist/${sid}`,"_blank");
      modal.classList.add('hidden');
    }catch(e){ alert(e.message || "Something went wrong"); }
  });

  (function(){
    const qs = new URLSearchParams(location.search);
    if(!qs.has("code")) return;
    fetch(`/api/auth/spotify/callback/?${qs}`,{
      headers:{Authorization:`Bearer ${API.getJWT()}`}
    })
    .then(r => {
      if (r.status === 200) {
        location.href = "/";
        return;
      }
      return r.json().then(data => {
        alert(data.detail || "Spotify connection failed");
      });
    })
    .catch(()=>alert("Spotify connection failed"))
    .finally(()=>history.replaceState({},"",location.pathname));
  })();
</script>
{% endblock %}