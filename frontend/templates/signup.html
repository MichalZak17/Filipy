{% extends "base.html" %}
{% load static %}

{% block title %}Sign Up{% endblock %}

{% block content %}
<body class="bg-gray-900 text-white font-sans">

    <section class="min-h-screen flex items-center justify-center">
        <div class="container mx-auto px-4">
            <div class="grid md:grid-cols-2 gap-12 items-center">
                <div class="text-center">
                    <img class="w-full max-w-md mx-auto" src="{% static 'assets/img/illustrations/register.svg' %}" alt="Sign up illustration">
                </div>
                <div class="bg-white/10 backdrop-blur-lg rounded-lg p-8 shadow-lg">
                    <h2 class="text-4xl font-bold mb-6 text-center">Create Account</h2>
                    <form method="post" action="{% url 'signup' %}">
                        {% csrf_token %}
                        <div id="form-error-messages" class="text-red-400 mb-4"></div>
                        <div class="mb-4">
                            <input class="w-full px-4 py-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:border-green-500" type="email" name="email" placeholder="Email" required>
                        </div>
                        <div class="mb-4">
                            <input class="w-full px-4 py-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:border-green-500" type="password" name="password" placeholder="Password" required>
                        </div>
                        <div class="mb-4">
                            <input class="w-full px-4 py-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:border-green-500" type="password" name="password_repeat" placeholder="Repeat Password" required>
                        </div>
                        <div class="mb-6">
                            <button class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition duration-300" type="submit">Create Account</button>
                        </div>
                    </form>
                    <div class="text-center text-gray-400">
                        <p>Have an account? <a href="{% url 'login' %}" class="hover:text-green-400">Log in</a></p>
                    </div>
                </div>
            </div>
        </div>
    </section>

</body>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[action="{% url 'signup' %}"]');
    const emailInput = form.querySelector('input[name="email"]');
    const passwordInput = form.querySelector('input[name="password"]');
    const passwordRepeatInput = form.querySelector('input[name="password_repeat"]');
    const errorContainer = document.getElementById('form-error-messages');
    const submitButton = form.querySelector('button[type="submit"]');

    form.addEventListener('submit', function(event) {
        event.preventDefault();
        errorContainer.innerHTML = '';
        submitButton.disabled = true;

        const email = emailInput.value.trim();
        const password = passwordInput.value;
        const passwordRepeat = passwordRepeatInput.value;
        let clientSideErrors = [];

        if (!email) {
            clientSideErrors.push('Email is required.');
        }
        if (!password) {
            clientSideErrors.push('Password is required.');
        }
        if (!passwordRepeat) {
            clientSideErrors.push('Please repeat your password.');
        }
        if (password && passwordRepeat && password !== passwordRepeat) {
            clientSideErrors.push('Passwords do not match.');
        }

        if (clientSideErrors.length > 0) {
            errorContainer.innerHTML = clientSideErrors.map(msg => `<p>${msg}</p>`).join('');
            submitButton.disabled = false;
            return;
        }

        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.status === 201) {
                window.location.href = '/home/';
            } else {
                return response.json().then(data => {
                    let messages = [];
                    if (data && typeof data === 'object') {
                        if (data.non_field_errors) {
                            messages = messages.concat(data.non_field_errors);
                        }
                        for (const field in data) {
                            if (field !== 'non_field_errors' && Array.isArray(data[field])) {
                                data[field].forEach(msg => messages.push(`${field.charAt(0).toUpperCase() + field.slice(1)}: ${msg}`));
                            }
                        }
                        if (messages.length === 0 && data.error) {
                             messages.push(data.error);
                        }
                         if (messages.length === 0 && data.detail) {
                             messages.push(data.detail);
                        }
                    }
                    if (messages.length === 0) {
                        messages.push(`Signup failed (Status: ${response.status}). Please check your input and try again.`);
                    }
                    errorContainer.innerHTML = messages.map(msg => `<p>${msg}</p>`).join('');
                }).catch(() => {
                    errorContainer.innerHTML = `<p>Signup failed (Status: ${response.status}). Invalid response from server.</p>`;
                });
            }
        })
        .catch(error => {
            console.error('Error submitting form:', error);
            errorContainer.innerHTML = '<p>A network error occurred. Please try again.</p>';
        })
        .finally(() => {
            submitButton.disabled = false;
        });
    });
});
</script>
{% endblock%}